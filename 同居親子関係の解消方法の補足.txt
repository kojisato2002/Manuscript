だいぶ前の話になってしまいますが、Cybozu Developer Network に寄稿させて頂いた記事について、ご質問を受けた事をきっかけに、自分自身でも、これでは記載が不足しているなと思う点がありましたので、ここに補足の情報を記載させて頂きます。
タイトルが怪しい故、検索エンジンなどからミスリードされて来た方には大変申し訳ありませんが、リアルな親子関係の話ではありません。小生が勤めるサイボウズという会社の、kintone という、 マジぱねえクラウドインターネッツ サービス の設計と設定に関する記事となりますので、悪しからずご了承くださいませ。もし、kintoneとは何か?に興味を持っていただけましたら、まとめサイトをご覧になられることをお奨めいたします。味わい深い記事の紹介や、事例ビデオなど、一言では語りつくせない kintone の魅力がちりばめられています。
さて、ご質問を頂いた記事では、kintone に標準で提供される「商品見積書パック」という、商品の見積書を作成するアプリを元に、見積書アプリの中にテーブルフィールドとして定義されていた明細情報を、アプリとして独立させる例を紹介させて頂きました、が、
「このあぷりでの「独立親子関係」への変更方法が良くわかりません」

とのご指摘を頂きました。確かに『「同居親子関係」にあるものを「独立親子関係」に変更する」』という段落からの説明は、説明や画面を省略している箇所が多く「ゔーん、これではわかりにくいかもしれない」と私自身も感じましたので、ここで再度説明をやり直しさせて頂きたいと思います。
また、本記事では、最終的にデータの整合性を維持するために、JavaScriptカスタマイズを適用しますので、きちんと動作させるには、スタンダードコースが必要となります。こちらにつきましても悪しからずご理解賜りたくよろしくお願い致します。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
まずは、元記事通り「商品見積書パック」を作成してみたいと思いますので、早速 kintone のポータル画面にてアプリの追加を、と言いたいところですが、この記事では、わかりやすさを追求したいと思いますので、私自身が感じるアプリ作成時の、もやもやポイントを回避しながら進めさせて頂きたいと思います。
特に、のちほど説明させて頂く「ルックアップ」や「関連レコード」の設定において、他のアプリを指定する場面があるのですが、そこでアプリ名の重複が許されれているが故に、判別が困難という問題を回避するために、最初にスペースを作成し、そのスペース内アプリとして作成いたします。その時に、スペース名の略称などでアプリ名を修飾することで、判別性を高めたいと思います。スペースについても名称の重複は許可されていますので、その点にも留意しましょう。
それでは、kintone のポータル画面からユーザーヘルプを参考に「はじめからスペースを作成する」にて「親子関係確認」という名前のスペースを作成しましょう。もちろん任意のものでも結構ですので、その場合は以降の記事中にある名前を置き換えて読んで下さいますよう、お願い致します。
左中心右削除
クリックしてキャプションを追加
「親子関係確認スペース」ができましたら、このスペースで利用できるスペース内アプリを作成します。ここでは元記事で取り扱っている「商品見積書パック」をアプリストアから作成します。スペース内アプリの作成方法につきましては、こちらをご参照ください。アプリストアは、今後もアプリが追加されることにより、デザインやアイコンの位置は変更になる可能性がありますが、本記事執筆時点のアイコンの位置は以下になります。もし、左ペインのカテゴリから探す場合は[業務で探す]-[営業・セールス]を選択してください。
左中心右削除
クリックしてキャプションを追加
上記画面の「商品見積書パック」をクリックすると、このアプリパックの詳細を説明する画面に遷移しますので、左ペインにある[このアプリパックを追加]リンクをクリックするか、上記画面の赤枠線内の[このアプリパックを追加]リンクをクリックすると、確認ダイアログが提示されるので[追加]ボタンをクリックしてください。すると、以下の画面のようにスペース内に、2つのアプリが作成されます。アプリパックはこのように、すぐに使える項目やサンプルのデータ等が設定された、1つ以上のアプリがワンクリックで追加され、目的の業務を遂行する上で参考になるものがたくさんありますので、ぜひご活用ください。
左中心右削除
クリックしてキャプションを追加
さて、前述の通りまずはアプリ名をスペース名の省略名で修飾してみましょう。とりあえず直訳で恐縮ですが親子関係ということで、Parent-Child Relation のイニシャルを採用した、PCRをその修飾名としたいと思います。実際の設定はアプリの管理機能で、この2つのアプリ名を、それぞれ以下のように変更します。
[商品リスト] => [PCR-商品リスト]
[見積書] => [PCR-見積書]
左中心右削除
クリックしてキャプションを追加
この修飾名(ブレフィクス)を付加するというのは、地味な作業ではありますが、スペースやアプリが増えていった場合などは、絶大な効果を発揮しますので、ネーミングのルールも含めて、設計時のTo Doリストに加えることをお勧めいたします。アプリ名を変更してしまうと「既に定義されたルックアップや、関連レコードの設定等に問題が生じるのでは?」と思われる方は、既にかなり kintone についてお詳しいのではと想像しますが、ご安心下さいませ。
左中心右削除
クリックしてキャプションを追加
右上画面から、[PCR-見積書]アプリの設定-フォームで[型番]フィールドを[設定]メニューにてご確認頂きますと、右下画面のように、kintoneよって自動的に変更後の新しい名称で参照するよう更新されている事がわかります。



左中心右削除
クリックしてキャプションを追加
さて、事前の準備もできましたので、いよいよ、1つの[見積書]アプリを、親情報=[見積書]と、子情報=[見積明細]の2つのアプリに分割したいと思います。まずは、子情報を保存する[PCR-見積明細]というアプリを新規で作成します。次に左の画面のように商品名、単価、個数、小計と[見積書]アプリに設定された子情報の項目と同じ項目を作成します。小計は計算フィールドですので、計算式の記述が必要になりますが[見積書]アプリを参考に計算式を設定してください。
左中心右削除
クリックしてキャプションを追加
続いて、左ペインより[ルックアップ]フィールドを選択し「商品名」フィールドの前にドラッグアンドドロップにて配置を行います。このフィールドは、「型番」の値を指定することにより、「PCR-商品リスト」から商品名と単価を取得するためのものです。 kintone ではこのように、他のアプリからデータを取得したいケースにおいて「ルックアップ」フィールドにて簡単に実装することができきます。
左中心右削除
クリックしてキャプションを追加
配置ができましたら、配置した部品の上にマウスカーソルを合わせ、右上の[設定アイコン]をクリックして、メニューコンテキストを表示させ、[設定]を選択します。すると、左記のように、設定画面が提示されますので、フィールド名には「型番」を設定します。次に[関連付けるアプリ*]ドロップダウンリストから「PCR-商品リスト」を選び[コピー先のフィールド*]にて「型番」を選択します。蛇足ながら、見積明細を入力される方が、もし「商品名」の方が値の入力として適切ということでしたら、もちろん「商品名」をコピー先のフィールドとして利用することも可能です。但し、その場合は、運用上の課題として、商品リストアプリの「商品名」に入力されている値(実際のデータ)に、レコードの判別が可能なユニークさが必要となります。
ここまでできましたら、一度、設定画面の[保存]ボタンにて保存を行い、アプリの設定画面の右上にある[アプリを更新]ボタンにて、設定内容を反映させましょう。その上で、実際のデータを入力してみます。まずはサンプルのデータを「PCR-商品リスト」アプリに何件か登録してみて下さい。CSV読込み設定を許可している場合は、こちらのデータをお使い、読込処理を行ってくださいませ。
「PCR-見積明細」アプリのレコード追加画面にて「型番」項目の右側にある[取得]リンクをクリックすると「PCR-商品リスト」に登録した商品がリストされますので、任意の商品を選択し、商品名と単価が反映され、個数を入力することにより、小計欄が計算されることをご確認下さい。
左中心右削除
クリックしてキャプションを追加
この「PCR-商品リスト」選択画面の左上にあるフィルターアイコンにて、商品を絞り込むことも可能ですし、「型番」フィールドに、検索例として「ks-」のみを入力して、[取得]リンクをクリックすると「ks-」で始まる型番のみの商品がリストされます。どのような検索キーワードが有効であるかるについては、こちらにまとめてありますので、ご参照下さいませ。
あとは「親情報」である「PCR-見積書」のアプリの設定 - フォームタブより、「子情報」としてテーブルフィールドとして定義されている型番、商品名、単価、個数、小計及び、合計金額(小計を計算として利用しているため)の各フィールドを削除します。既にデータが入力されている場合は、以下のようなメッセージが出力されますので、データも削除されてよいかを確認してください。
左中心右削除
クリックしてキャプションを追加
これで「同居親子関係」にあった「親情報」である見積書アプリから「子情報」である見積明細の情報がアプリとして独立することになりました。しかしながら、このままでは、肝心の親子関係が全く築けず(見積と見積明細の関連が設定されていない)、勘当して家出した状態です。ここは独立しつつも親子関係を維持するために、親のキーを保持するように、フィールドを追加しましょう。
ということで「PCR-見積明細」アプリに「PCR-見積書」アプリの何らかのルックアップフィールドを追加したいのですが、フィールドとして妥当なものは何になるでしょう? 言い換えますと「PCR-見積書」のキー項目は何でしょう? 「PCR-商品リスト」の場合は「型番」がアプリのキーとして[値の重複を禁止する]設定になっていますので、あまり迷うことなくルックアップ時に、コピー先のフィールドとして指定していましたが、標準の状態で見積書アプリの各フィールドには[必須項目]も[値の重複を禁止する]も設定されていないので、困ってしまいます。このような場合、いくつかの方法が考えられます。
元記事では「PCR-見積書」アプリの「見積番号」を「PCR-見積明細」にルックアップフィールドとして参照するようにしていますが、ルックアップ先のキーが安定(必須かつ重複禁止)していない項目の場合、意図しない結果となる可能性があり、私が言うのも何ですが(汗)あまりお勧めできません。もちろん、「PCR-見積書」アプリの「見積番号」に対して[必須項目]も[値の重複を禁止する]も設定すれば、この問題は解決するのですが、折角ですので、別の方法で解決してみたいと思います。
実は、kintoneには、内部的にアプリ毎に管理しているレコード番号というものがあり、この情報は常にアプリ内の一意性を保証する安定した情報で、アプリの管理フォームタブページから、通常のフィールドと同じようにフォームに配置することが可能です。内部的に発番される情報ですので、読み取り専用ではありますが、早速「PCR-見積書」アプリにこの「レコード番号」を追加してみましょう。
左中心右削除
クリックしてキャプションを追加
上記画面のように、[レコード番号]フィールドを追加したらフィールドの[設定]メニューにて[フィールド名]と[フィールドコード]を「見積書レコード番号」に修正します。[アプリを更新]リンクにて「PCR-見積書」アプリの更新を行い正常に更新が反映されたことを確認してください。

左中心右削除
クリックしてキャプションを追加
次に「PCR-見積明細」アプリの設定画面に戻り、先ほどの「PCR-商品リスト」を「型番」で「コピー先のフィールド」に指定したのと同じ要領で、ルックアップフィールドを追加します。具体的な指定内容としては右画面のように[関連付けるアプリ*]コンボボックスにて「PCR-見積書」を選択し[コピー元のフィールド*]コンボボックスでは、一つ前の画面で追加設定を行った「見積書レコード番号」を指定します。
[コピー元のレコード選択時に表示するフィールド]は、この明細(子情報)が、どの見積書(親情報)に所属するのかを選択するダイアログの中に表示する項目の設定ですので、識別できる項目を選択しましょう。[フィールドコード]には、スクリプトで参照される「見積番号_lookup」という名称を設定してください。
以上の操作で、新たに作成した「PCR-見積明細]アプリが親情報である[PCR-見積書]アプリとの親子関係を維持しつつ、独立する事ができました。動作確認のためにデータを登録するにあたりましては、以下の画面のように、既に登録された[PCR-見積書]アプリのレコードに対して「PCR-見積明細]アプリにレコードを登録する際に、上記で設定を行ったルックアップを通じ、親レコードへのリンクを登録する流れとなります。
左中心右削除
クリックしてキャプションを追加
さて、見積書自体の方ですが、明細を管理していたテーブルフィールドが削除されていま(子供に出て行かれた親の状態ですね)すのでだいぶ寂しい状態になっていますから、ここはkintoneの「関連レコード」フィールドの機能を利用して「子情報」を表示するようにしましょう。
「PCR-見積書」アプリの設定-フォームから、[関連レコード一覧]フィールドを、元テーブルがあったところにドラッグアンドドロップします。フォーム上に(設定が必要です)というメッセージが出ていますので、設定メニューから、ダイアログを表示させ、以下の入力内容を参考に設定を行いましょう。
左中心右削除
クリックしてキャプションを追加
以上の設定後、サンプルデータを入力した[PCR-見積書]アプリのレコード参照画面が以下のようになります。
左中心右削除
クリックしてキャプションを追加
うーん、シンプル。概ね、今回の修正前の情報がそのまま表示されているように見えますが、明細の合計金額がありません( ﾟдﾟ )。合計金額をスクリプトで計算する部分については、元記事と同様の内容で対応が可能ですが、今回は、明細からの参照キーを見積番号ではなく、レコード番号を利用している点、見積明細には明細行の設定は行っていないのが相違点となります。その点も考慮した上で、再度計算の為の設定変更を行いましょう。
左中心右削除
クリックしてキャプションを追加
まず[PCR-見積書]には、見積金額の表示数値フィールドを配置します。フィールド名及びフィールドコードも「見積金額」として保存してください。合計の表示箇所として適切な場所に来るように、スペースフィールドの幅も、適当に調整致します。

左中心右削除
クリックしてキャプションを追加
次に[PCR-見積明細]に、やはり数値項目の「修正前小計」というフィールドコード名のフィールドを配置します。このフィールドは、スクリプトのみが使用しますので、グループフィールドなどを用い、一般ユーザーからは見えないようにしてもよいかもしれません。
これで、アプリの設定で行う操作は全て完了しました。あとは、元記事で紹介している、見積明細アプリにレコードを登録、変更、削除した時に、見積アプリの見積金額を更新するスクリプトを[PCR-見積明細]アプリに適用するのみです。スクリプトについては、ほとんど変更無く、元記事の解説を参照頂けると幸いです。
なお、今回見積明細アプリから、見積アプリへの参照キーを見積書レコード番号に変更したことにより、一箇所のみ変更されていますので、こちらの、Gistから、変更後のスクリプトを取得してください。
また、このスクリプト適用前に登録していたデータは、正しく計算できませんので[PCR-見積書][PCR-見積明細]それぞれデータを消去してから、適用後、データの登録を行ってください。
左中心右削除
変更前[PCR-見積書]

左中心右削除
見積明細一覧3行目の100G増設の個数を一つ減らしました

左中心右削除
変更後[PCR-見積書]、計算あってますね(ホッ)
以上、気付くのがだいぶ遅れたと思いますが、Facebook のノート機能がどんなもんか試してみたかったのもあり、補足のドキュメントとして記載してみました。ご質問やお気づきの点がございましたら、何なりとコメント下さいませー。
